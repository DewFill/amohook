# Обработчик Webhooks от AmoCRM
## Что делает эта библиотека
Она позволяет с легкостью обрабатывать WebHooks от AmoCRM без необходимости писать большое количество логики проверок сущности хука и события, а также наличия различных переменных в теле запроса. Просто сфокусируйтесь на обработке, а разбор данных доверьте этому классу. 

## Установка
```
composer require opravdin/amohook
```

## Использование
### Метод 1. Получение данных в упрощенной форме
Самый простой вариант использования: работайте сразу с обработанными данными
```
use Opravdin\AmoHook;

// Использование без фреймворков
$raw = $_POST;
$data = (new AmoHook($_POST))->get();
foreach ($data as $event) {
    echo "Action $event->action on entity $event->entity";
}
```
или
```
use Opravdin\AmoHook;

// Использование без фреймворков
$raw = $_POST;
$data = AmoHook::build($raw)->get();

// Использование с Laravel Request
$objectRaw = $request->all();
$data = AmoHook::fromObject($objectRaw)->get();
```

содержимое $data:
```
[
    [
        'entity' => 'contacts',
        'action' => 'update',
        'data' => ['id' => ..., 'name' => ..., ...]
    ],
    ...
]
```

### Метод 2. Использование цепочки вызова
Использование расширенных возможностей класса: регистрируйте методы обратного вызова
```
$anyHandler = function ($data) {
    echo "Action: '$data->action' on entity '$data->entity'";
}
$specificHandler = function ($data) {
    // Вызывается только для контактов и компаний при обновлении
}

AmoHook->build($_POST)
    ->register('any', 'any' $anyHandler)
    ->register(['contacts', 'companies'], 'update', $specificHandler)
    ->handle();
```
Регистрируйте сразу несколько действий/сущностей при помощи массивов или передавайте строки для выборочной регистрации. Метод получит событие как параметр вызова.  
  
Вы можете изучить тесты (tests) для изучения работы класса
## Формат массива события
* entity - название сущности в соответствие с хуком амо (кроме компаний, они обрабатываются как companies)
* action - название события (например, add или update)
* data - тело события. Включает в себя все данные из хука по данному событию (id, name и так далее). Эквивалентно $request['сущность']['событие'][0]

## Доступные сущности и события
Все сущности и события именуются согласно их названию в Webhooks AmoCRM (leads, contacts и update, add и т.д.). Стоит отметить, что библиотека корректно различает контакты и компании: contacts и companies соответственно.
Дополнительно можно использовать any для определения сущностей и событий для методов обратного вызова.  

## Внесение вклада
Я с удовольствием приму ваши комментарии, предложения и доработки в Issues или Pull requests :)
